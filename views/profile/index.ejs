<%- include('../partials/head') %>

<%- include('../partials/navbar') %>

<main class="container mx-auto px-4 pt-20 pb-8">
  <div class="max-w-2xl mx-auto">
    <% // Використовуємо formData з flash, якщо воно є (після помилки валідації) %>
    <% const currentUsername = formData && formData.username ? formData.username : user.username %>
    <% const currentEmail = formData && formData.email ? formData.email : user.email %>
    <% const currentAboutMe = formData && formData.about_me ? formData.about_me : (user.about_me || '') %>
    <% 
      let currentBirthday = '';
      if (formData && formData.birthday) { // formData.birthday тепер завжди рядок 'YYYY-MM-DD' або порожній
        currentBirthday = formData.birthday;
      } else if (user.birthday) {
        // Тепер user.birthday - це JS Date об'єкт, що представляє північ UTC.
        // Наприклад, для '2000-05-17' в БД, це буде Date об'єкт для 2000-05-17T00:00:00.000Z
        const dateObj = new Date(user.birthday); // Створюємо копію або використовуємо напряму
        if (!isNaN(dateObj.getTime())) {
          // dateObj.toISOString() дасть "2000-05-17T00:00:00.000Z"
          // .split('T')[0] коректно витягне "2000-05-17"
          currentBirthday = dateObj.toISOString().split('T')[0];
        }
      }
    %>

    <% if (success && success.length > 0) { %>
      <div class="alert-dismissible bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4 relative" role="alert">
        <span class="block sm:inline"><%= success[0] %></span> <% /* Відображаємо перше повідомлення з масиву */ %>
        <button type="button" class="alert-close-btn absolute top-0 bottom-0 right-0 px-4 py-3" aria-label="Close">
          <svg class="fill-current h-6 w-6 text-green-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
        </button>
      </div>
    <% } %>

    <% if (error && error.length > 0) { %>
      <div class="alert-dismissible bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 relative" role="alert">
        <span class="block sm:inline"><%= error[0] %></span> <% /* Відображаємо перше повідомлення з масиву */ %>
        <button type="button" class="alert-close-btn absolute top-0 bottom-0 right-0 px-4 py-3" aria-label="Close">
          <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
        </button>
      </div>
    <% } %>

    <% if (errors && errors.length > 0) { %>
      <div class="alert-dismissible bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 relative" role="alert">
        <strong class="font-bold">Будь ласка, виправте наступні помилки:</strong>
        <ul class="list-disc list-inside mt-2">
          <% errors.forEach(err => { %>
            <li><%= err.msg %></li>
          <% }); %>
        </ul>
        <button type="button" class="alert-close-btn absolute top-0 right-0 px-4 py-3" aria-label="Close">
          <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
        </button>
      </div>
    <% } %>

    <form action="/profile" method="POST" enctype="multipart/form-data" class="bg-white shadow-md rounded-lg p-6 md:p-8">
      <!-- ... Avatar upload section ... -->
      <div class="flex flex-col items-center mb-8">
        <img 
          src="<%= user.profile_image_url ? user.profile_image_url : '/images/default-avatar.png' %>" 
          alt="User Avatar" 
          class="w-24 h-24 md:w-32 md:h-32 rounded-full object-cover mb-4 border-2 border-gray-200"
          id="avatarPreview"
        >
        <label for="avatar" class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm transition duration-150 ease-in-out">
          Змінити аватар
        </label>
        <input type="file" name="avatar" id="avatar" class="hidden" accept="image/png, image/jpeg, image/gif, image/webp" onchange="previewAvatar(event)">
        <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF, WEBP до 5MB</p>
      </div>

      <h3 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Персональні дані</h3>
      
      <div class="space-y-6">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Ім'я користувача</label>
          <input 
            type="text" 
            name="username" 
            id="username" 
            value="<%= currentUsername %>" 
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          >
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input 
            type="email" 
            name="email" 
            id="email" 
            value="<%= currentEmail %>" 
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          >
        </div>

        <div>
          <label for="about_me" class="block text-sm font-medium text-gray-700 mb-1">Про себе</label>
          <textarea 
            name="about_me" 
            id="about_me" 
            rows="4"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            placeholder="Розкажіть трохи про себе..."
          ><%= currentAboutMe %></textarea>
        </div>

        <div>
          <label for="birthday" class="block text-sm font-medium text-gray-700 mb-1">Дата народження</label>
          <input 
            type="date" 
            name="birthday" 
            id="birthday" 
            value="<%= currentBirthday %>"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          >
        </div>

        <div class="border-t border-gray-200 pt-6">
          <h4 class="text-lg font-medium text-gray-900 mb-1">Зміна пароля</h4>
          <p class="text-sm text-gray-500 mb-4">Заповніть ці поля, якщо бажаєте змінити поточний пароль.</p>
          
          <div class="space-y-4">
            <div>
              <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">Поточний пароль</label>
              <input
                type="password"
                name="currentPassword"
                id="currentPassword"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                placeholder="••••••"
                autocomplete="current-password"
              >
            </div>

            <div>
              <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">Новий пароль</label>
              <input
                type="password"
                name="newPassword"
                id="newPassword"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                placeholder="Мінімум 6 символів"
                autocomplete="new-password"
              >
            </div>

            <div>
              <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-1">Підтвердіть новий пароль</label>
              <input
                type="password"
                name="confirmNewPassword"
                id="confirmNewPassword"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                placeholder="Повторіть новий пароль"
                autocomplete="new-password"
              >
            </div>
          </div>
        </div>
      </div>

      <div class="mt-8">
        <button 
          type="submit" 
          class="w-full bg-slate-700 hover:bg-slate-800 text-white font-semibold py-2.5 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition duration-150 ease-in-out"
        >
          Зберегти зміни
        </button>
      </div>
    </form>

    <!-- Керувати обліковим записом -->
    <div class="mt-8 bg-white shadow-md rounded-lg p-6 md:p-8">
      <h4 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-3">Керувати обліковим записом</h4>
      <div class="flex justify-between items-center">
        <p class="text-gray-600">Видалити профіль</p>
        <a href="#" class="text-red-600 hover:text-red-700 hover:underline font-medium">Видалити</a>
      </div>
      <p class="text-xs text-gray-500 mt-1">Ця дія є незворотною. Функціонал видалення буде реалізовано пізніше.</p>
    </div>
  </div>
</main>

<script>
  function previewAvatar(event) {
    const reader = new FileReader();
    reader.onload = function(){
      const output = document.getElementById('avatarPreview');
      output.src = reader.result;
    };
    if (event.target.files[0]) {
      reader.readAsDataURL(event.target.files[0]);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Обробники для кнопок закриття повідомлень
    const alertCloseButtons = document.querySelectorAll('.alert-close-btn');
    alertCloseButtons.forEach(button => {
      button.addEventListener('click', function() {
        // Знаходимо батьківський елемент повідомлення та приховуємо його
        this.closest('.alert-dismissible').style.display = 'none';
      });
    });

    // Автоматичне приховування повідомлень через 7 секунд
    const alerts = document.querySelectorAll('.alert-dismissible');
    alerts.forEach(alert => {
      setTimeout(() => {
        // Перевіряємо, чи повідомлення ще не було закрито вручну
        if (alert.style.display !== 'none') {
          alert.style.display = 'none'; // Просто приховуємо
        }
      }, 7000); // 7000 мілісекунд = 7 секунд
    });
  });
</script>

<%- include('../partials/footer') %>