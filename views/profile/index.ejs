<%- include('../partials/head') %>

<%- include('../partials/navbar') %>

<main class="container mx-auto px-4 pt-20 pb-8">
  <div class="max-w-2xl mx-auto">
    <% // Використовуємо formData з flash, якщо воно є (після помилки валідації) %>
    <% const currentUsername = formData && formData.username ? formData.username : user.username %>
    <% const currentEmail = formData && formData.email ? formData.email : user.email %>

    <% if (success && success.length > 0) { %>
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4" role="alert">
        <p><%= success %></p>
      </div>
    <% } %>

    <% if (error && error.length > 0) { %> <% /* Загальна помилка, наприклад, від multer */ %>
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" role="alert">
        <p><%= error %></p>
      </div>
    <% } %>

    <% if (errors && errors.length > 0) { %> <% /* Помилки валідації */ %>
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" role="alert">
        <p class="font-bold">Будь ласка, виправте наступні помилки:</p>
        <ul class="list-disc list-inside">
          <% errors.forEach(err => { %>
            <li><%= err.msg %></li>
          <% }); %>
        </ul>
      </div>
    <% } %>

    <form action="/profile" method="POST" enctype="multipart/form-data" class="bg-white shadow-md rounded-lg p-6 md:p-8">
      <div class="flex flex-col items-center mb-8">
        <img 
          src="<%= user.profile_image_url ? user.profile_image_url : '/images/default-avatar.png' %>" 
          alt="User Avatar" 
          class="w-24 h-24 md:w-32 md:h-32 rounded-full object-cover mb-4 border-2 border-gray-200"
          id="avatarPreview"
        >
        <label for="avatar" class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm transition duration-150 ease-in-out">
          Змінити аватар
        </label>
        <input type="file" name="avatar" id="avatar" class="hidden" accept="image/png, image/jpeg, image/gif" onchange="previewAvatar(event)">
        <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF до 5MB</p>
      </div>

      <h3 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Персональні дані</h3>
      
      <div class="space-y-6">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Ім'я користувача</label>
          <input 
            type="text" 
            name="username" 
            id="username" 
            value="<%= currentUsername %>" 
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          >
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input 
            type="email" 
            name="email" 
            id="email" 
            value="<%= currentEmail %>" 
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          >
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Новий пароль (залиште порожнім, щоб не змінювати)</label>
          <input 
            type="password" 
            name="password" 
            id="password"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            placeholder="••••••"
          >
          <p class="text-xs text-gray-500 mt-1">Мінімум 6 символів. Функціонал зміни паролю буде реалізовано пізніше.</p>
        </div>
      </div>

      <div class="mt-8">
        <button 
          type="submit" 
          class="w-full bg-slate-700 hover:bg-slate-800 text-white font-semibold py-2.5 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition duration-150 ease-in-out"
        >
          Зберегти зміни
        </button>
      </div>
    </form>

    <!-- Керувати обліковим записом -->
    <div class="mt-8 bg-white shadow-md rounded-lg p-6 md:p-8">
      <h4 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-3">Керувати обліковим записом</h4>
      <div class="flex justify-between items-center">
        <p class="text-gray-600">Видалити профіль</p>
        <a href="#" class="text-red-600 hover:text-red-700 hover:underline font-medium">Видалити</a>
      </div>
      <p class="text-xs text-gray-500 mt-1">Ця дія є незворотною. Функціонал видалення буде реалізовано пізніше.</p>
    </div>
  </div>
</main>

<script>
  function previewAvatar(event) {
    const reader = new FileReader();
    reader.onload = function(){
      const output = document.getElementById('avatarPreview');
      output.src = reader.result;
    };
    if (event.target.files[0]) {
      reader.readAsDataURL(event.target.files[0]);
    }
  }
</script>

<%- include('../partials/footer') %>