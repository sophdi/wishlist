<!DOCTYPE html>
<html lang="uk">

<head>
  <%- include('../partials/head') %>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
  <%- include('../partials/navbar') %>
  
  <main class="container mx-auto px-4 py-8 pt-24 flex-grow">
    <div class="max-w-6xl mx-auto">
      <% // Використовуємо formData з flash, якщо воно є (після помилки валідації) %>
      <% const currentUsername = formData && formData.username ? formData.username : user.username %>
      <% const currentEmail = formData && formData.email ? formData.email : user.email %>
      <% const currentAboutMe = formData && formData.about_me ? formData.about_me : (user.about_me || '') %>
      <% 
        let currentBirthday = '';
        if (formData && formData.birthday) { // formData.birthday тепер завжди рядок 'YYYY-MM-DD' або порожній
          currentBirthday = formData.birthday;
        } else if (user.birthday) {
          // Тепер user.birthday - це JS Date об'єкт, що представляє північ UTC.
          // Наприклад, для '2000-05-17' в БД, це буде Date об'єкт для 2000-05-17T00:00:00.000Z
          const dateObj = new Date(user.birthday); // Створюємо копію або використовуємо напряму
          if (!isNaN(dateObj.getTime())) {
            // dateObj.toISOString() дасть "2000-05-17T00:00:00.000Z"
            // .split('T')[0] коректно витягне "2000-05-17"
            currentBirthday = dateObj.toISOString().split('T')[0];
          }
        }
      %>

      <!-- Header Section -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Налаштування</h1>
        <p class="text-gray-600">Керуйте своїм профілем та налаштуваннями облікового запису</p>
      </div>

      <!-- Mobile Navigation -->
      <div class="lg:hidden mb-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex overflow-x-auto space-x-1">
            <button class="menu-item active flex-shrink-0 flex items-center px-3 py-2 text-xs font-medium rounded-lg whitespace-nowrap" data-tab="profile">
              <svg class="w-4 h-4 mr-1 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
              Профіль
            </button>
            <button class="menu-item flex-shrink-0 flex items-center px-3 py-2 text-xs font-medium text-gray-600 rounded-lg whitespace-nowrap" data-tab="security">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
              Безпека
            </button>
            <button class="menu-item flex-shrink-0 flex items-center px-3 py-2 text-xs font-medium text-red-600 rounded-lg whitespace-nowrap" data-tab="danger">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.865-.833-2.634 0L4.168 16.5c-.77.833.192 2.5 1.732 2.5z"/>
              </svg>
              Небезпечна зона
            </button>
          </div>
        </div>
      </div>

      <div class="flex gap-8">
        <!-- Desktop Sidebar Menu -->
        <div class="hidden lg:block w-64 flex-shrink-0">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <nav class="space-y-2">
              <button class="menu-item active flex items-center px-3 py-2 text-sm font-medium rounded-lg w-full text-left" data-tab="profile">
                <svg class="w-5 h-5 mr-3 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Профіль
              </button>
              <button class="menu-item flex items-center px-3 py-2 text-sm font-medium text-gray-600 rounded-lg w-full text-left" data-tab="security">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                Безпека
              </button>
              <div class="border-t border-gray-200 mt-4 pt-4">
                <button class="menu-item flex items-center px-3 py-2 text-sm font-medium text-red-600 rounded-lg w-full text-left" data-tab="danger">
                  <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.865-.833-2.634 0L4.168 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                  </svg>
                  Небезпечна зона
                </button>
              </div>
            </nav>
          </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 lg:ml-0">
          <!-- Alerts -->
          <% if (success && success.length > 0) { %>
            <div class="alert-dismissible bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl mb-6 relative" role="alert">
              <span class="block sm:inline"><%= success[0] %></span>
              <button type="button" class="alert-close-btn absolute top-0 bottom-0 right-0 px-4 py-3" aria-label="Close">
                <svg class="fill-current h-6 w-6 text-green-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
              </button>
            </div>
          <% } %>

          <% if (error && error.length > 0) { %>
            <div class="alert-dismissible bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-6 relative" role="alert">
              <span class="block sm:inline"><%= error[0] %></span>
              <button type="button" class="alert-close-btn absolute top-0 bottom-0 right-0 px-4 py-3" aria-label="Close">
                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
              </button>
            </div>
          <% } %>

          <% if (errors && errors.length > 0) { %>
            <div class="alert-dismissible bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-6 relative" role="alert">
              <strong class="font-bold">Будь ласка, виправте наступні помилки:</strong>
              <ul class="list-disc list-inside mt-2">
                <% errors.forEach(err => { %>
                  <li><%= err.msg %></li>
                <% }); %>
              </ul>
              <button type="button" class="alert-close-btn absolute top-0 right-0 px-4 py-3" aria-label="Close">
                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
              </button>
            </div>
          <% } %>

          <!-- Profile Tab -->
          <div id="profile-tab" class="tab-content">
            <form action="/profile" method="POST" enctype="multipart/form-data" class="bg-white shadow-sm rounded-xl border border-gray-200 p-6 md:p-8">
              
              <!-- Avatar Section -->
              <div class="flex flex-col items-center mb-8">
                <img 
                  src="<%= user.profile_image_url ? user.profile_image_url : '/images/default-avatar.png' %>" 
                  alt="User Avatar" 
                  class="w-24 h-24 md:w-32 md:h-32 rounded-full object-cover mb-4 border-2 border-gray-200"
                  id="avatarPreview"
                >
                <label for="avatar" class="cursor-pointer bg-purple-600 text-white font-medium py-2 px-4 rounded-lg text-sm">
                  Змінити аватар
                </label>
                <input type="file" name="avatar" id="avatar" class="hidden" accept="image/png, image/jpeg, image/gif, image/webp" onchange="previewAvatar(event)">
                <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF, WEBP до 5MB</p>
              </div>

              <!-- Personal Information -->
              <h3 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Персональні дані</h3>
              
              <div class="space-y-6">
                <div>
                  <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Ім'я користувача</label>
                  <input 
                    type="text" 
                    name="username" 
                    id="username" 
                    value="<%= currentUsername %>" 
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                  >
                </div>

                <div>
                  <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input 
                    type="email" 
                    name="email" 
                    id="email" 
                    value="<%= currentEmail %>" 
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                  >
                </div>

                <div>
                  <label for="about_me" class="block text-sm font-medium text-gray-700 mb-1">Про себе</label>
                  <textarea 
                    name="about_me" 
                    id="about_me" 
                    rows="4"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                    placeholder="Розкажіть трохи про себе..."
                  ><%= currentAboutMe %></textarea>
                </div>

                <div>
                  <label for="birthday" class="block text-sm font-medium text-gray-700 mb-1">Дата народження</label>
                  <input 
                    type="date" 
                    name="birthday" 
                    id="birthday" 
                    value="<%= currentBirthday %>"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                  >
                </div>
              </div>

              <!-- Submit Button -->
              <div class="mt-8">
                <button 
                  type="submit" 
                  class="bg-purple-600 text-white font-semibold py-2.5 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
                >
                  Зберегти зміни
                </button>
              </div>
            </form>
          </div>

          <!-- Security Tab -->
          <div id="security-tab" class="tab-content hidden">
            <form action="/profile" method="POST" class="bg-white shadow-sm rounded-xl border border-gray-200 p-6 md:p-8">
              <h3 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Зміна пароля</h3>
              
              <div class="space-y-6">
                <div>
                  <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">Поточний пароль</label>
                  <input
                    type="password"
                    name="currentPassword"
                    id="currentPassword"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                    placeholder="••••••"
                    autocomplete="current-password"
                  >
                </div>

                <div>
                  <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">Новий пароль</label>
                  <input
                    type="password"
                    name="newPassword"
                    id="newPassword"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                    placeholder="Мінімум 6 символів"
                    autocomplete="new-password"
                  >
                </div>

                <div>
                  <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-1">Підтвердіть новий пароль</label>
                  <input
                    type="password"
                    name="confirmNewPassword"
                    id="confirmNewPassword"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                    placeholder="Повторіть новий пароль"
                    autocomplete="new-password"
                  >
                </div>
              </div>

              <div class="mt-8">
                <button 
                  type="submit" 
                  class="bg-purple-600 text-white font-semibold py-2.5 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
                >
                  Оновити пароль
                </button>
              </div>
            </form>
          </div>

          <!-- Notifications Tab -->
          <div id="notifications-tab" class="tab-content hidden">
            <div class="bg-white shadow-sm rounded-xl border border-gray-200 p-6 md:p-8">
              <h3 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Налаштування сповіщень</h3>
              
              <div class="space-y-6">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="text-sm font-medium text-gray-900">Email сповіщення</h4>
                    <p class="text-sm text-gray-500">Отримувати сповіщення на електронну пошту</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                  </label>
                </div>
                
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="text-sm font-medium text-gray-900">Push сповіщення</h4>
                    <p class="text-sm text-gray-500">Отримувати push сповіщення в браузері</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                  </label>
                </div>
              </div>

              <div class="mt-8">
                <button 
                  type="button"
                  class="bg-purple-600 text-white font-semibold py-2.5 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
                >
                  Зберегти налаштування
                </button>
              </div>
            </div>
          </div>

          <!-- Privacy Tab -->
          <div id="privacy-tab" class="tab-content hidden">
            <div class="bg-white shadow-sm rounded-xl border border-gray-200 p-6 md:p-8">
              <h3 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Налаштування приватності</h3>
              
              <div class="space-y-6">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="text-sm font-medium text-gray-900">Публічний профіль</h4>
                    <p class="text-sm text-gray-500">Дозволити іншим бачити ваш профіль</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                  </label>
                </div>
                
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="text-sm font-medium text-gray-900">Показувати вішлісти</h4>
                    <p class="text-sm text-gray-500">Дозволити іншим бачити ваші вішлісти</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                  </label>
                </div>
              </div>

              <div class="mt-8">
                <button 
                  type="button"
                  class="bg-purple-600 text-white font-semibold py-2.5 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
                >
                  Зберегти налаштування
                </button>
              </div>
            </div>
          </div>

          <!-- Danger Zone Tab -->
          <div id="danger-tab" class="tab-content hidden">
            <div class="bg-white shadow-sm rounded-xl border border-red-200 p-6 md:p-8">
              <h3 class="text-xl font-semibold mb-6 text-red-700 border-b border-red-200 pb-3">Небезпечна зона</h3>
              
              <div class="space-y-6">
                <div class="flex justify-between items-center">
                  <div>
                    <p class="text-gray-700 font-medium">Видалити профіль</p>
                    <p class="text-sm text-gray-500">Ця дія є незворотною. Всі ваші дані будуть видалені назавжди.</p>
                  </div>
                  <button class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
                    Видалити обліковий запис
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('../partials/footer') %>

  <script>
    function previewAvatar(event) {
      const reader = new FileReader();
      reader.onload = function(){
        const output = document.getElementById('avatarPreview');
        output.src = reader.result;
      };
      if (event.target.files[0]) {
        reader.readAsDataURL(event.target.files[0]);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Menu tab switching
      const menuItems = document.querySelectorAll('.menu-item');
      const tabContents = document.querySelectorAll('.tab-content');

      menuItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          
          // Remove active class from all menu items
          menuItems.forEach(mi => {
            mi.classList.remove('active', 'bg-purple-50', 'text-purple-600');
            mi.classList.add('text-gray-600', 'hover:bg-gray-100');
          });
          
          // Add active class to clicked item
          item.classList.add('active', 'bg-purple-50', 'text-purple-600');
          item.classList.remove('text-gray-600', 'hover:bg-gray-100');
          
          // Hide all tab contents
          tabContents.forEach(tc => tc.classList.add('hidden'));
          
          // Show selected tab content
          const tabId = item.getAttribute('data-tab') + '-tab';
          document.getElementById(tabId).classList.remove('hidden');
        });
      });

      // Set initial active state
      const activeItem = document.querySelector('.menu-item.active');
      if (activeItem) {
        activeItem.classList.add('bg-purple-50', 'text-purple-600');
        activeItem.classList.remove('text-gray-600', 'hover:bg-gray-100');
      }

      // Обробники для кнопок закриття повідомлень
      const alertCloseButtons = document.querySelectorAll('.alert-close-btn');
      alertCloseButtons.forEach(button => {
        button.addEventListener('click', function() {
          this.closest('.alert-dismissible').style.display = 'none';
        });
      });

      // Автоматичне приховування повідомлень через 7 секунд
      const alerts = document.querySelectorAll('.alert-dismissible');
      alerts.forEach(alert => {
        setTimeout(() => {
          if (alert.style.display !== 'none') {
            alert.style.display = 'none';
          }
        }, 7000);
      });
    });
  </script>
</body>

</html>